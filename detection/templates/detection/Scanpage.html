{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Scan for Diseases - E.T.C. CAM" %}</title>
    <link rel="icon" type="image/png" href="{% static 'img/ETC_LOGO2.png' %}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        html { scroll-behavior: smooth; }

        body {
            background-image: url('{% static "img/background.jpg" %}');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            margin: 0;
            font-family: 'Inter', sans-serif;
            color: #111827;
        }
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            z-index: -1;
        }

        .nav-bg { background-color: #52533c; }

        .nav-link {
            position: relative;
            display: inline-block;
            padding: 10px 15px;
            font-size: 1rem;
            color: white;
            text-decoration: none;
            font-weight: 500;
        }
        .nav-link::after {
            content: "";
            position: absolute;
            left: 50%;
            bottom: 0;
            width: 0;
            height: 3px;
            background: #d1d5db;
            border-radius: 9999px;
            transition: width 0.3s ease, left 0.3s ease;
        }
        .nav-link:hover::after { width: 100%; left: 0; }

        .primary-btn {
            padding: 0.5rem 1.2rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.95rem;
            background-color: #5b913a;
            color: white;
            transition: all 0.3s ease;
        }
        .primary-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .nav-logo {
            height: 10rem;
            width: auto;
            filter: drop-shadow(0 0 4px rgba(0,0,0,0.4));
        }

        /* Mobile home icon button */
        .home-icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            border: 2px solid #ffffff;
            color: #ffffff;
            background: transparent;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .home-icon-btn:hover {
            background-color: rgba(255,255,255,0.1);
            transform: translateY(-1px);
        }

        /* Camera / image layout */
        #camera-preview {
            width: 100%;
            max-width: 700px;
            height: auto;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
            transform: scaleX(-1);
            -webkit-transform: scaleX(-1);
        }
        #uploaded-image {
            width: 100%;
            height: auto;
            border-radius: 10px;
            margin: 20px auto;
            display: none;
        }

        /* Updated: icon buttons use #a09a8b background, not white */
        .icon-btn {
            background-color: #a09a8b;
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .icon-btn:hover {
            background-color: #8f8878;
            transform: translateY(-1px);
        }

        /* Updated: shutter / capture button also #a09a8b */
        #shutter-btn {
            background-color: #a09a8b;
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, background-color 0.3s ease;
        }
        #shutter-btn:hover {
            background-color: #8f8878;
            transform: scale(1.05);
        }

        #retake-btn {
            background-color: #8f8878;
            border: 2px solid white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #retake-btn:hover {
            background-color: #8f8878;
        }

        #scan-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
            display: none;
            margin-left: 20px;
        }
        #scan-btn:hover { background-color: #45a049; }
        #scan-btn:disabled {
            background-color: #6b7280;
            cursor: not-allowed;
        }

        .camera-actions {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .loading {
            display: none;
            font-size: 1.5rem;
            margin-top: 20px;
            text-align: center;
        }

        .scan-content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            margin-top: 2rem;
        }
        @media (min-width: 768px) {
            .scan-content-grid {
                grid-template-columns: 1fr 1fr;
                align-items: start;
            }
        }

        #scan-result-container {
            margin-top: 20px;
            background-color: rgba(45,62,47,0.9);
            border-radius: 10px;
            padding: 20px;
            color: white;
            text-align: left;
            overflow-y: auto;
            max-height: 400px;
        }
        #scan-result-container h3,
        #scan-result-container h4 {
            font-weight: bold;
            margin-bottom: 5px;
            color: #a7f3d0;
        }
        #scan-result-container p { margin-bottom: 10px; line-height: 1.6; }

        .plant-selection-buttons-wrapper {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-left: -20px;
            margin-right: -20px;
            padding-left: 20px;
            padding-right: 20px;
        }
        .plant-selection-buttons-wrapper button {
            background-color: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            white-space: nowrap;
        }
        .plant-selection-buttons-wrapper button:hover {
            background-color: rgba(255,255,255,0.3);
            border-color: white;
        }
        .plant-selection-buttons-wrapper button.selected {
            background-color: #4CAF50;
            border-color: #4CAF50;
            font-weight: bold;
        }
        .plant-selection-buttons-wrapper button:disabled {
            background-color: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.5);
            cursor: not-allowed;
        }

        #hover-restart-message {
            display: none;
            color: #ef4444;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        #custom-modal {
            background-color: rgba(0,0,0,0.7);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: #1e293b;
        }

        @media (max-width: 768px) {
            nav { height: 64px; }
            .page-wrapper { padding-top: calc(64px + 24px); }
            .desktop-back-btn { display: none; }
            .mobile-home-wrapper { display: inline-flex; }
            .camera-actions {
                flex-direction: column;
                gap: 10px;
                margin-top: 10px;
            }
            #scan-btn {
                margin-left: 0;
                width: 80%;
            }
        }
        @media (min-width: 769px) {
            nav { height: 80px; }
            .page-wrapper { padding-top: calc(80px + 24px); }
            .desktop-back-btn { display: inline-block; }
            .mobile-home-wrapper { display: none; }
        }
    </style>
</head>
<body class="h-screen overflow-y-auto">

<nav class="fixed top-0 left-0 w-full nav-bg text-white z-40 shadow-md flex items-center">
    <div class="flex items-center w-full max-w-6xl mx-auto px-4 md:px-8">
        <a href="{% url 'dashboard_page' %}" class="flex items-center gap-2">
            <img src="{% static 'img/ETC_LOGO2.png' %}" class="nav-logo">
        </a>

        <div class="ml-auto flex items-center gap-3">
            <a href="{% url 'dashboard_page' %}"
               class="primary-btn desktop-back-btn">
                <i class="fas fa-arrow-left mr-1"></i> {% trans "Back to Dashboard" %}
            </a>

            <a href="{% url 'dashboard_page' %}" class="mobile-home-wrapper">
                <span class="home-icon-btn">
                    <i class="fas fa-home"></i>
                </span>
            </a>
        </div>
    </div>
</nav>

<div class="page-wrapper">
    <div class="max-w-6xl mx-auto px-4 md:px-8 py-8">
        <h1 class="text-center text-3xl md:text-4xl font-extrabold mb-4 text-gray-800">
            {% trans "SCAN FOR DISEASES" %}
        </h1>
        <p class="text-center text-lg mb-8 text-gray-600">
            {% trans "DETECT DISEASES OF EGGPLANT, TOMATO, OR CHILI PEPPER" %}
        </p>

        <div class="scan-content-grid">
            <!-- Left: camera / upload -->
            <div>
                <video id="camera-preview" autoplay></video>
                <img id="uploaded-image" src="#"
                     alt="{% trans 'Scanned Plant Image' %}">

                <div class="camera-actions">
                    <div class="flex justify-center items-center space-x-8">
                        <!-- Upload button -->
                        <div class="icon-btn" onclick="openImageUpload()">
                            <i class="fas fa-images text-white text-2xl"></i>
                        </div>

                        <!-- Capture button -->
                        <div id="shutter-btn" onclick="captureImage()">
                            <i class="fas fa-camera text-white text-2xl"></i>
                        </div>

                        <!-- Retake button -->
                        <div id="retake-btn" onclick="retakePhoto()">
                            <i class="fas fa-sync-alt text-white text-2xl"></i>
                        </div>
                    </div>
                    <button id="scan-btn" onclick="scanImage()">
                        {% trans "SCAN IMAGE" %}
                    </button>
                </div>

                <div class="loading" id="loading">
                    <i class="fas fa-spinner fa-spin"></i> {% trans "Scanning..." %}
                </div>
            </div>

            <!-- Right: results -->
            <div id="scan-result-container">
                <h3 class="text-2xl mb-2 text-center">
                    {% trans "Choose the plant first before scanning:" %}
                </h3>

                <div id="plant-selection-buttons" class="plant-selection-buttons-wrapper">
                    <button id="chili-btn" onclick="selectPlantType('chili')">
                        {% trans "Chili Pepper" %}
                    </button>
                    <button id="eggplant-btn" onclick="selectPlantType('eggplant')">
                        {% trans "Eggplant" %}
                    </button>
                    <button id="tomato-btn" onclick="selectPlantType('tomato')">
                        {% trans "Tomato" %}
                    </button>
                </div>

                <p id="hover-restart-message">
                    {% trans "Please re-start the scanning again." %}
                </p>

                <h3 class="text-2xl mt-4 mb-2">{% trans "Scan Result:" %}</h3>
                <p id="scan-result-name" class="text-xl">
                    {% trans "Detected: Awaiting Scan" %}
                </p>
                <p id="scan-result-confidence" class="text-lg mb-4">
                    {% trans "Confidence: N/A" %}
                </p>

                <h4 class="text-xl mt-4 mb-2">{% trans "Description:" %}</h4>
                <p id="scan-result-description" class="text-base">
                    {% trans "Perform a scan to get detailed information about the detected disease, its symptoms, and prevention strategies." %}
                </p>

                <h4 class="text-xl mt-4 mb-2">{% trans "Symptoms:" %}</h4>
                <p id="scan-result-symptoms" class="text-base">
                    {% trans "Symptoms will appear here after a successful scan." %}
                </p>

                <h4 class="text-xl mt-4 mb-2">{% trans "Prevention Strategies:" %}</h4>
                <p id="scan-result-prevention" class="text-base">
                    {% trans "Prevention methods will be displayed here." %}
                </p>
            </div>
        </div>
    </div>
</div>

<input type="file" id="image-upload" accept="image/*"
       style="display:none;" onchange="handleImageUpload(event)">

<meta name="csrf-token" content="{{ csrf_token }}">

<div id="custom-modal"
     class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70">
    <div class="modal-content bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border-2 border-gray-700">
        <div class="flex justify-between items-center mb-4">
            <h4 id="modal-title" class="text-xl font-bold text-white"></h4>
            <button onclick="closeMessageModal()"
                    class="text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <p id="modal-message" class="text-gray-300"></p>
        <div class="mt-6 text-right">
            <button onclick="closeMessageModal()"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                OK
            </button>
        </div>
    </div>
</div>

<script>
    let selectedPlantType = null;
    let isImageCapturedOrUploaded = false;
    let isScanCompleted = false;
    let currentImageFile = null;

    let cameraStream = null;
    const cameraPreview = document.getElementById('camera-preview');
    const uploadedImage = document.getElementById('uploaded-image');
    const shutterBtn = document.getElementById('shutter-btn');
    const retakeBtn = document.getElementById('retake-btn');
    const scanBtn = document.getElementById('scan-btn');
    const loading = document.getElementById('loading');
    const plantSelectionButtonsWrapper = document.getElementById('plant-selection-buttons');
    const hoverRestartMessage = document.getElementById('hover-restart-message');

    const scanResultName = document.getElementById('scan-result-name');
    const scanResultConfidence = document.getElementById('scan-result-confidence');
    const scanResultDescription = document.getElementById('scan-result-description');
    const scanResultSymptoms = document.getElementById('scan-result-symptoms');
    const scanResultPrevention = document.getElementById('scan-result-prevention');

    function getCurrentLanguage() {
        const path = window.location.pathname;
        if (path.startsWith('/tl/')) return 'tl';
        if (path.startsWith('/en/')) return 'en';
        return 'en';
    }

    function getDetectionUrl() {
        const lang = getCurrentLanguage();
        return `/${lang}/detection/detect/`;
    }

    function updateUIState() {
        if (isImageCapturedOrUploaded && selectedPlantType && !isScanCompleted) {
            scanBtn.style.display = 'inline-block';
        } else {
            scanBtn.style.display = 'none';
        }

        const plantButtons = plantSelectionButtonsWrapper.querySelectorAll('button');
        plantButtons.forEach(btn => { btn.disabled = isScanCompleted; });

        hoverRestartMessage.style.display = 'none';
    }

    async function startCamera() {
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
            cameraPreview.srcObject = cameraStream;
        } catch (error) {
            displayMessageModal(
                "{% translate 'Error accessing the camera:' %} " + error.message +
                ". {% translate 'Please ensure camera permissions are granted or upload an image.' %}"
            );
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        startCamera();
        updateUIState();

        plantSelectionButtonsWrapper.addEventListener('mouseover', () => {
            if (isScanCompleted) {
                hoverRestartMessage.style.display = 'block';
            }
        });
        plantSelectionButtonsWrapper.addEventListener('mouseout', () => {
            hoverRestartMessage.style.display = 'none';
        });
    });

    function captureImage() {
        const canvas = document.createElement('canvas');
        canvas.width = cameraPreview.videoWidth;
        canvas.height = cameraPreview.videoHeight;
        const ctx = canvas.getContext('2d');

        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(function (blob) {
            currentImageFile = new File([blob], 'captured_image.png', { type: 'image/png' });

            uploadedImage.src = URL.createObjectURL(blob);
            uploadedImage.style.display = 'block';
            cameraPreview.style.display = 'none';

            shutterBtn.style.display = 'none';
            retakeBtn.style.display = 'flex';

            isImageCapturedOrUploaded = true;
            isScanCompleted = false;
            updateUIState();
            resetScanResultDisplay();
        }, 'image/png');
    }

    function retakePhoto() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(t => t.stop());
        }
        cameraPreview.srcObject = null;
        startCamera();

        uploadedImage.style.display = 'none';
        cameraPreview.style.display = 'block';

        shutterBtn.style.display = 'flex';
        retakeBtn.style.display = 'none';

        isImageCapturedOrUploaded = false;
        isScanCompleted = false;
        selectedPlantType = null;
        currentImageFile = null;
        updatePlantButtonSelection(null);
        updateUIState();
        resetScanResultDisplay();
    }

    function openImageUpload() {
        document.getElementById('image-upload').click();
    }

    function handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (cameraStream) {
            cameraStream.getTracks().forEach(t => t.stop());
            cameraPreview.srcObject = null;
        }

        currentImageFile = file;
        const reader = new FileReader();
        reader.onload = function (ev) {
            uploadedImage.src = ev.target.result;
            uploadedImage.style.display = 'block';
            cameraPreview.style.display = 'none';

            shutterBtn.style.display = 'none';
            retakeBtn.style.display = 'flex';

            isImageCapturedOrUploaded = true;
            isScanCompleted = false;
            updateUIState();
            resetScanResultDisplay();
        };
        reader.readAsDataURL(file);
    }

    function selectPlantType(plant) {
        if (isScanCompleted) return;
        selectedPlantType = plant;
        updatePlantButtonSelection(plant);
        updateUIState();
    }

    function updatePlantButtonSelection(selected) {
        const buttons = plantSelectionButtonsWrapper.querySelectorAll('button');
        buttons.forEach(button => {
            if (selected && button.id.startsWith(selected)) {
                button.classList.add('selected');
            } else {
                button.classList.remove('selected');
            }
        });
    }

    function resetScanResultDisplay() {
        scanResultName.textContent = "{% translate 'Detected: Awaiting Scan' %}";
        scanResultConfidence.textContent = "{% translate 'Confidence: N/A' %}";
        scanResultDescription.textContent =
            "{% translate 'Perform a scan to get detailed information about the detected disease, its symptoms, and prevention strategies.' %}";
        scanResultSymptoms.textContent =
            "{% translate 'Symptoms will appear here after a successful scan.' %}";
        scanResultPrevention.textContent =
            "{% translate 'Prevention methods will be displayed here.' %}";
    }

    async function scanImage() {
        if (!currentImageFile) {
            displayMessageModal("{% translate 'Please capture or upload an image first.' %}");
            return;
        }
        if (!selectedPlantType) {
            displayMessageModal("{% translate 'Please select the type of plant you are scanning.' %}");
            return;
        }

        loading.style.display = 'block';
        isScanCompleted = false;
        updateUIState();
        resetScanResultDisplay();

        const formData = new FormData();
        formData.append('image', currentImageFile);
        formData.append('plant_type', selectedPlantType);
        formData.append('language', getCurrentLanguage());

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        try {
            const response = await fetch(getDetectionUrl(), {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData,
            });

            if (response.ok) {
                const data = await response.json();

                loading.style.display = 'none';
                isScanCompleted = true;

                // Use backend confidence and thresholding for accuracy
                // Expect backend to return fields: disease, confidence, description, symptoms, prevention
                const diseaseName = data.disease || data.result || 'Unknown';
                const confidenceValue = data.confidence || "N/A";

                scanResultName.textContent = `{% translate 'Detected:' %} ${diseaseName}`;
                scanResultConfidence.textContent = `{% translate 'Confidence:' %} ${confidenceValue}`;
                scanResultDescription.textContent = data.description || '';
                scanResultSymptoms.textContent = data.symptoms || '';
                scanResultPrevention.textContent = data.prevention || '';

            } else {
                let errorMessage = '{% translate "Unknown error occurred" %}';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorData.message || errorMessage;
                } catch (e) {
                    errorMessage = `Server returned ${response.status} status`;
                }

                loading.style.display = 'none';
                isScanCompleted = true;
                scanResultName.textContent = `{% translate 'Error:' %} ${errorMessage}`;
                scanResultConfidence.textContent = '{% translate "Confidence: N/A" %}';
                scanResultDescription.textContent = '';
                scanResultSymptoms.textContent = '';
                scanResultPrevention.textContent = '';
            }
        } catch (error) {
            loading.style.display = 'none';
            isScanCompleted = true;
            scanResultName.textContent = `{% translate 'Network Error:' %} ${error.message || error}`;
            scanResultConfidence.textContent = '{% translate "Confidence: N/A" %}';
            scanResultDescription.textContent = '';
            scanResultSymptoms.textContent = '';
            scanResultPrevention.textContent = '';
        } finally {
            updateUIState();
        }
    }

    function displayMessageModal(message, title = '{% translate "Notification" %}') {
        const modal = document.getElementById('custom-modal');
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = message;
        modal.classList.remove('hidden');
    }
    function closeMessageModal() {
        document.getElementById('custom-modal').classList.add('hidden');
    }
</script>
</body>
</html>
