{% load static %}
{% load i18n %} {# Load i18n tags for translation #}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Scan for Diseases - E.T.C. CAM" %}</title> {# Marked for translation #}
    <link rel="icon" type="image/png" href="{% static 'img/ETC_LOGO2.png' %}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Global Styles */
        html {
            scroll-behavior: smooth;
        }
        body {
            background-image: url('{% static 'img/background.jpg' %}');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: white;
            font-family: 'Inter', sans-serif; /* Using Inter font as per guidelines */
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }

        /* Navbar Styling */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            font-weight: 600;
            background: rgba(0, 0, 0, 0.3); /* Slightly transparent background for the nav itself */
            z-index: 10;
        }
        nav .logo-link {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            text-decoration: none;
        }
        nav a.logo-link {
            text-decoration: none;
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }
        nav a.logo-link img {
            width: auto;
            height: 4rem; /* Consistent logo height */
            margin-right: 0.5rem;
            object-fit: contain;
        }
        .nav-actions {
            display: flex;
            gap: 1rem;
        }
        .nav-actions a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            position: relative;
        }
        .nav-actions a::after {
            content: "";
            position: absolute;
            left: 50%;
            bottom: -3px;
            width: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 9999px;
            transition: width 0.3s ease, left 0.3s ease;
        }
        .nav-actions a:hover::after {
            width: 100%;
            left: 0;
        }

        /* Camera Preview Styling */
        #camera-preview {
            width: 100%; /* Keep it responsive within its container */
            max-width: 700px; /* Increased maximum width */
            height: auto;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
            transform: scaleX(-1);
            -webkit-transform: scaleX(-1);
        }

        /* Uploaded Image Styling */
        #uploaded-image {
            width: 100%;
            height: auto;
            border-radius: 10px;
            margin: 20px auto;
            display: none;
        }

        /* Icon Button Styling */
        .icon-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .icon-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        /* Shutter Button Styling */
        #shutter-btn {
            background-color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }
        #shutter-btn:hover {
            transform: scale(1.1);
        }

        /* Retake Button Styling */
        #retake-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #retake-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        /* Scan Button Styling */
        #scan-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
            display: none; /* Stays hidden until plant is selected AND image is ready */
            margin-left: 20px; /* Space from other camera buttons */
        }
        #scan-btn:hover {
            background-color: #45a049;
        }

        /* Scan Button Disabled State */
        #scan-btn:disabled {
            background-color: #6b7280; /* Gray out when disabled */
            cursor: not-allowed;
        }


        /* Loading Animation */
        .loading {
            display: none;
            font-size: 1.5rem;
            margin-top: 20px;
            text-align: center;
        }

        /* Scan Result Styling */
        #scan-result-container {
            margin-top: 20px;
            background-color: rgba(45, 62, 47, 0.8); /* Card-like background */
            border-radius: 10px;
            padding: 20px;
            color: white;
            text-align: left;
            overflow-y: auto; /* Enable scrolling for long descriptions */
            max-height: 400px; /* Limit height of the result container */
        }
        #scan-result-container h3, #scan-result-container h4 {
            font-weight: bold;
            margin-bottom: 5px;
            color: #a7f3d0; /* Light green for titles */
        }
        #scan-result-container p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        /* Buttons Container */
        .camera-actions {
            display: flex;
            flex-direction: row; 
            align-items: center;
            justify-content: center; /* Center the entire group of buttons */
            gap: 20px;
            margin-top: 20px;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .nav-actions a.back-button-text {
                display: none; /* Hide the text button on smaller screens */
            }
            .nav-actions a.back-button-icon {
                display: flex !important; /* Show the icon button */
                align-items: center;
                justify-content: center;
                background-color: rgba(255, 255, 255, 0.2);
                border: 2px solid white;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                padding: 0;
            }
            .nav-actions a.back-button-icon i {
                font-size: 1.2rem;
            }

            /* Stack elements vertically on small screens */
            .scan-content-grid {
                grid-template-columns: 1fr;
            }
            #uploaded-image, #camera-preview {
                max-width: 100%; /* Take full width on small screens */
                margin-left: auto;
                margin-right: auto;
            }
            /* Adjust camera actions for small screens */
            .camera-actions {
                flex-direction: column; /* Stack buttons vertically again */
                gap: 10px;
                margin-top: 10px;
            }
            #scan-btn {
                margin-left: 0; /* Remove horizontal margin when stacked */
                width: 80%; /* Make scan button wider */
            }
        }

        /* Initially hide the icon button */
        .nav-actions a.back-button-icon {
            display: none;
        }

        /* New Layout for Image and Details */
        .scan-content-grid {
            display: grid;
            grid-template-columns: 1fr; /* Default to single column for small screens */
            gap: 24px; /* Tailwind gap-6 */
            margin-top: 2rem;
        }
        @media (min-width: 768px) { /* md breakpoint for two columns */
            .scan-content-grid {
                grid-template-columns: 1fr 1fr; /* Two columns for medium screens and up */
                align-items: start; /* Align items to the top of their grid areas */
            }
            #uploaded-image {
                max-width: 100%; /* Allow image to fill its grid column */
            }
        }

        /* Plant Selection Buttons */
        .plant-selection-buttons-wrapper {
            display: flex; /* Always visible and flex container */
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px; /* Space between buttons and scan result title */
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            padding: 10px 0; /* Add some vertical padding within the card */
            border-bottom: 1px solid rgba(255, 255, 255, 0.2); /* Separator line */
            margin-left: -20px; /* Extend border to full width of card */
            margin-right: -20px; /* Extend border to full width of card */
            padding-left: 20px; /* Adjust padding to match card */
            padding-right: 20px; /* Adjust padding to match card */
        }
        .plant-selection-buttons-wrapper button {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            white-space: nowrap; /* Prevent text wrapping inside buttons */
        }
        .plant-selection-buttons-wrapper button:hover {
            background-color: rgba(255, 255, 255, 0.3);
            border-color: white;
        }
        .plant-selection-buttons-wrapper button.selected {
            background-color: #4CAF50;
            border-color: #4CAF50;
            font-weight: bold;
        }
        /* Plant Selection Button Disabled State */
        .plant-selection-buttons-wrapper button:disabled {
            background-color: rgba(255, 255, 255, 0.05); /* Lighter background when disabled */
            border-color: rgba(255, 255, 255, 0.1); /* Faded border */
            color: rgba(255, 255, 255, 0.5); /* Faded text */
            cursor: not-allowed; /* Indicate non-interactable */
        }

        /* Hover Restart Message Styling */
        #hover-restart-message {
            display: none; /* Hidden by default */
            color: #ef4444; /* Red text (Tailwind red-500) */
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem; /* Slightly smaller than main text */
            animation: fadeIn 0.3s ease-out; /* Quick fade-in */
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Custom Modal CSS (replaces alert/confirm) */
        #custom-modal {
            background-color: rgba(0, 0, 0, 0.7);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: #1e293b; /* A nice dark blue-gray */
        }
    </style>
</head>
<body class="h-screen overflow-y-auto">

    <nav class="fixed top-0 left-0 w-full flex justify-between items-center p-6 text-white font-semibold bg-transparent">
        <a href="#" class="logo-link">
            <img src="{% static 'img/ETC_LOGO.png' %}" alt="{% trans 'ETC Logo' %}"> {# Alt text marked for translation #} {% trans "E.T.C. CAM" %} {# Marked for translation #}
        </a>
        <div class="nav-actions">
            <a href="{% url 'dashboard_page' %}" class="back-button-text hover-effect bg-green-600 text-white px-6 py-2 rounded shadow hover:bg-green-700">{% trans "Back to Dashboard" %}</a> {# Marked for translation #}
            <a href="{% url 'dashboard_page' %}" class="back-button-icon hover-effect">
                <i class="fas fa-home"></i>
            </a>
        </div>
    </nav>

    {# Added a transparent header div to fill the space below the fixed navbar #}
    <div class="w-full h-24 bg-black bg-opacity-50 fixed top-0 left-0 z-5"></div> 

    <div class="container mx-auto mt-24 p-6"> {# This mt-24 ensures content is below the navbar #}
        <h1 class="text-center text-4xl font-bold mb-8">{% trans "SCAN FOR DISEASES" %}</h1> {# Marked for translation #}
        <p class="text-center text-lg mb-8">{% trans "DETECT DISEASES OF EGGPLANT, TOMATO, OR CHILI PEPPER" %}</p> {# Marked for translation #}

        <!-- Main content area for camera/image and results -->
        <div class="scan-content-grid">
            <!-- Left Column: Camera Preview / Uploaded Image -->
            <div>
                <video id="camera-preview" autoplay></video>
                <img id="uploaded-image" src="#" alt="{% trans 'Scanned Plant Image' %}"> {# Alt text marked for translation #}

                <div class="camera-actions">
                    <div class="flex justify-center items-center space-x-8">
                        <div class="icon-btn" onclick="openImageUpload()">
                            <i class="fas fa-images text-white text-2xl"></i>
                        </div>

                        <div id="shutter-btn" onclick="captureImage()">
                            <i class="fas fa-camera text-gray-800 text-2xl"></i>
                        </div>

                        <div id="retake-btn" onclick="retakePhoto()">
                            <i class="fas fa-sync-alt text-white text-2xl"></i>
                        </div>
                    </div>
                    {# Moved Scan Button here #}
                    <button id="scan-btn" onclick="scanImage()">{% trans "SCAN IMAGE" %}</button> {# Marked for translation #}
                </div>
                
                <div class="loading" id="loading">
                    <i class="fas fa-spinner fa-spin"></i> {% trans "Scanning..." %} {# Marked for translation #}
                </div>
            </div>

            <!-- Right Column: Scan Result Details -->
            <div id="scan-result-container">
                <h3 class="text-2xl mb-2 text-center">{% trans "Choose the plant first before scanning:" %}</h3> {# Marked for translation #}
                <!-- Plant Selection Buttons - ALWAYS VISIBLE INSIDE THE RESULT CARD -->
                <div id="plant-selection-buttons" class="plant-selection-buttons-wrapper">
                    <button id="chili-btn" onclick="selectPlantType('chili')">{% trans "Chili Pepper" %}</button> {# Marked for translation #}
                    <button id="eggplant-btn" onclick="selectPlantType('eggplant')">{% trans "Eggplant" %}</button> {# Marked for translation #}
                    <button id="tomato-btn" onclick="selectPlantType('tomato')">{% trans "Tomato" %}</button> {# Marked for translation #}
                </div>
                <!-- Hover message for disabled buttons -->
                <p id="hover-restart-message">{% trans "Please re-start the scanning again." %}</p> {# Marked for translation #}

                <h3 class="text-2xl mt-4 mb-2">{% trans "Scan Result:" %}</h3> {# Marked for translation #}
                <p id="scan-result-name" class="text-xl">{% trans "Detected: Awaiting Scan" %}</p> {# Marked for translation #}
                <p id="scan-result-confidence" class="text-lg mb-4">{% trans "Confidence: N/A" %}</p> {# Marked for translation #}
                
                <h4 class="text-xl mt-4 mb-2">{% trans "Description:" %}</h4> {# Marked for translation #}
                <p id="scan-result-description" class="text-base">{% trans "Perform a scan to get detailed information about the detected disease, its symptoms, and prevention strategies." %}</p> {# Marked for translation #}

                <h4 class="text-xl mt-4 mb-2">{% trans "Symptoms:" %}</h4> {# Marked for translation #}
                <p id="scan-result-symptoms" class="text-base">{% trans "Symptoms will appear here after a successful scan." %}</p> {# Marked for translation #}

                <h4 class="text-xl mt-4 mb-2">{% trans "Prevention Strategies:" %}</h4> {# Marked for translation #}
                <p id="scan-result-prevention" class="text-base">{% trans "Prevention methods will be displayed here." %}</p> {# Marked for translation #}
                
            </div>
        </div>
    </div>

    <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">

    {# Include CSRF token as a meta tag for JavaScript access #}
    <meta name="csrf-token" content="{{ csrf_token }}">

    {# Custom Modal for displaying messages (replaces alert() and confirm()) #}
    <div id="custom-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70">
        <div class="modal-content bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border-2 border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h4 id="modal-title" class="text-xl font-bold text-white"></h4>
                <button onclick="closeMessageModal()" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p id="modal-message" class="text-gray-300"></p>
            <div class="mt-6 text-right">
                <button onclick="closeMessageModal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    OK
                </button>
            </div>
        </div>
    </div>

   <script>
        // Store the currently selected plant type
        let selectedPlantType = null; 
        let isImageCapturedOrUploaded = false; // Track if an image is ready
        let isScanCompleted = false; // Track if a scan has finished
        let currentImageFile = null; // Store the uploaded file object
        
        // Access the camera and display the preview
        let cameraStream = null;
        const cameraPreview = document.getElementById('camera-preview');
        const uploadedImage = document.getElementById('uploaded-image');
        const shutterBtn = document.getElementById('shutter-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const scanBtn = document.getElementById('scan-btn');
        const loading = document.getElementById('loading');
        const plantSelectionButtonsWrapper = document.getElementById('plant-selection-buttons'); 
        const hoverRestartMessage = document.getElementById('hover-restart-message');
        
        // Elements for detailed results
        const scanResultContainer = document.getElementById('scan-result-container');
        const scanResultName = document.getElementById('scan-result-name');
        const scanResultConfidence = document.getElementById('scan-result-confidence');
        const scanResultDescription = document.getElementById('scan-result-description');
        const scanResultSymptoms = document.getElementById('scan-result-symptoms');
        const scanResultPrevention = document.getElementById('scan-result-prevention');

        // Function to get current language from URL
        function getCurrentLanguage() {
            const path = window.location.pathname;
            if (path.startsWith('/tl/')) return 'tl';
            if (path.startsWith('/en/')) return 'en';
            return 'en'; // default to English
        }

        // Function to get the correct detection URL
        function getDetectionUrl() {
            // Use absolute URL with current language prefix
            const currentLang = getCurrentLanguage();
            return `/${currentLang}/detection/detect/`;
        }

        // Helper to update visibility of the scan button and disable/enable plant buttons
        function updateUIState() {
            // Scan button visibility
            if (isImageCapturedOrUploaded && selectedPlantType && !isScanCompleted) {
                scanBtn.style.display = 'inline-block';
            } else {
                scanBtn.style.display = 'none';
            }

            // Plant type buttons enabled/disabled state
            const plantButtons = plantSelectionButtonsWrapper.querySelectorAll('button');
            plantButtons.forEach(button => {
                button.disabled = isScanCompleted; // Disable if scan is completed
            });
            
            // Hide the hover message initially or after state change
            hoverRestartMessage.style.display = 'none'; 
        }

        // Function to start the camera automatically
        async function startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraPreview.srcObject = cameraStream;
            } catch (error) {
                displayMessageModal("{% translate 'Error accessing the camera:' %} " + error.message + ". {% translate 'Please ensure camera permissions are granted or upload an image.' %}");
            }
        }

        // Start the camera and set initial UI state when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            startCamera();
            updateUIState(); // Set initial UI state
            
            // Add mouseover/mouseout listeners to the plant selection buttons wrapper
            plantSelectionButtonsWrapper.addEventListener('mouseover', () => {
                if (isScanCompleted) {
                    hoverRestartMessage.style.display = 'block';
                }
            });

            plantSelectionButtonsWrapper.addEventListener('mouseout', () => {
                hoverRestartMessage.style.display = 'none';
            });
        });

        // Function to capture an image from the camera
        function captureImage() {
            const canvas = document.createElement('canvas');
            canvas.width = cameraPreview.videoWidth;
            canvas.height = cameraPreview.videoHeight;
            const context = canvas.getContext('2d');

            // Flip the context horizontally
            context.translate(canvas.width, 0);
            context.scale(-1, 1);

            // Draw the mirrored video frame onto the canvas
            context.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);

            // Convert canvas to blob and create a File object
            canvas.toBlob(function(blob) {
                currentImageFile = new File([blob], 'captured_image.png', { type: 'image/png' });
                
                // Display the captured image
                uploadedImage.src = URL.createObjectURL(blob);
                uploadedImage.style.display = 'block';
                cameraPreview.style.display = 'none';

                // Hide shutter button and show retake button
                shutterBtn.style.display = 'none';
                retakeBtn.style.display = 'flex';

                isImageCapturedOrUploaded = true;
                isScanCompleted = false;
                updateUIState();
                resetScanResultDisplay();
            }, 'image/png');
        }

        // Function to retake a photo
        function retakePhoto() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            cameraPreview.srcObject = null;
            startCamera();

            uploadedImage.style.display = 'none';
            cameraPreview.style.display = 'block';

            shutterBtn.style.display = 'flex';
            retakeBtn.style.display = 'none';

            isImageCapturedOrUploaded = false;
            isScanCompleted = false;
            selectedPlantType = null;
            currentImageFile = null;
            updatePlantButtonSelection(null);
            updateUIState();
            resetScanResultDisplay();
        }

        // Function to open the file upload dialog
        function openImageUpload() {
            document.getElementById('image-upload').click();
        }

        // Function to handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraPreview.srcObject = null;
                }

                currentImageFile = file;
                const reader = new FileReader();
                reader.onload = function (e) {
                    uploadedImage.src = e.target.result;
                    uploadedImage.style.display = 'block';
                    cameraPreview.style.display = 'none';

                    shutterBtn.style.display = 'none';
                    retakeBtn.style.display = 'flex';

                    isImageCapturedOrUploaded = true;
                    isScanCompleted = false;
                    updateUIState();
                    resetScanResultDisplay();
                };
                reader.readAsDataURL(file);
            }
        }

        // Function to select a plant type
        function selectPlantType(plant) {
            if (isScanCompleted) {
                return;
            }
            selectedPlantType = plant;
            updatePlantButtonSelection(plant);
            updateUIState();
        }

        // Helper to update visual styling of plant buttons
        function updatePlantButtonSelection(selected) {
            const buttons = plantSelectionButtonsWrapper.querySelectorAll('button');
            buttons.forEach(button => {
                if (selected && button.id.startsWith(selected)) { 
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
            });
        }

        // Helper to reset the scan result display fields to default placeholder text
        function resetScanResultDisplay() {
            scanResultName.textContent = "{% translate 'Detected: Awaiting Scan' %}";
            scanResultConfidence.textContent = "{% translate 'Confidence: N/A' %}";
            scanResultDescription.textContent = "{% translate 'Perform a scan to get detailed information about the detected disease, its symptoms, and prevention strategies.' %}";
            scanResultSymptoms.textContent = "{% translate 'Symptoms will appear here after a successful scan.' %}";
            scanResultPrevention.textContent = "{% translate 'Prevention methods will be displayed here.' %}";
        }

        // Function to send the image to the backend for scanning
        async function scanImage() {
            if (!currentImageFile) {
                displayMessageModal("{% translate 'Please capture or upload an image first.' %}");
                return;
            }

            if (!selectedPlantType) {
                displayMessageModal("{% translate 'Please select the type of plant you are scanning.' %}");
                return;
            }

            loading.style.display = 'block';
            isScanCompleted = false;
            updateUIState();
            resetScanResultDisplay();
            
            const formData = new FormData();
            formData.append('image', currentImageFile);
            formData.append('plant_type', selectedPlantType);
            formData.append('language', getCurrentLanguage()); // Add current language to form data

            // Get CSRF token from meta tag
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            console.log('=== STARTING SCAN REQUEST ===');
            console.log('Selected plant type:', selectedPlantType);
            console.log('Current language:', getCurrentLanguage());
            console.log('Detection URL:', getDetectionUrl());
            console.log('CSRF token exists:', !!csrfToken);

            try {
                // Use the correct URL with language prefix
                const response = await fetch(getDetectionUrl(), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData,
                });

                console.log('=== SCAN RESPONSE RECEIVED ===');
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (response.ok) {
                    const data = await response.json();
                    console.log('API Response DATA:', data);
                    
                    loading.style.display = 'none';
                    isScanCompleted = true;
                    
                    // Use the correct field names from the backend response
                    const diseaseName = data.disease || data.result || 'Unknown';
                    const confidenceValue = data.confidence || "N/A";
                    
                    console.log('Using disease name:', diseaseName);
                    console.log('Using confidence:', confidenceValue);
                    console.log('Response language:', data.language);
                    
                    // Populate scan result details
                    scanResultName.textContent = `{% translate 'Detected:' %} ${diseaseName}`;
                    scanResultConfidence.textContent = `{% translate 'Confidence:' %} ${confidenceValue}`;
                    scanResultDescription.textContent = data.description || '';
                    scanResultSymptoms.textContent = data.symptoms || '';
                    scanResultPrevention.textContent = data.prevention || '';

                    console.log('=== VERIFYING DOM UPDATES ===');
                    console.log('scanResultName content:', scanResultName.textContent);
                    console.log('scanResultConfidence content:', scanResultConfidence.textContent);

                } else {
                    let errorMessage = '{% translate "Unknown error occurred" %}';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || errorMessage;
                        console.log('Error response data:', errorData);
                    } catch (e) {
                        errorMessage = `Server returned ${response.status} status`;
                    }
                    
                    loading.style.display = 'none';
                    isScanCompleted = true;
                    scanResultName.textContent = `{% translate 'Error:' %} ${errorMessage}`;
                    scanResultConfidence.textContent = '{% translate 'Confidence: N/A' %}';
                    scanResultDescription.textContent = '';
                    scanResultSymptoms.textContent = '';
                    scanResultPrevention.textContent = '';
                }
            } catch (error) {
                console.error('=== SCAN NETWORK ERROR ===', error);
                loading.style.display = 'none';
                isScanCompleted = true;
                scanResultName.textContent = `{% translate 'Network Error:' %} ${error.message || error}`;
                scanResultConfidence.textContent = '{% translate 'Confidence: N/A' %}';
                scanResultDescription.textContent = '';
                scanResultSymptoms.textContent = '';
                scanResultPrevention.textContent = '';
            } finally {
                console.log('=== SCAN COMPLETED ===');
                console.log('isScanCompleted:', isScanCompleted);
                updateUIState();
            }
        }

        // Custom Modal for Messages
        function displayMessageModal(message, title = '{% translate "Notification" %}') {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        function closeMessageModal() {
            const modal = document.getElementById('custom-modal');
            modal.classList.add('hidden');
        }
    </script>
</body>
</html>